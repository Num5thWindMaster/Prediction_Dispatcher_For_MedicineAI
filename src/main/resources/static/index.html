<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<html>
<head>
    <title>File Upload Example</title>
</head>
<body>
<h2>Predict for blabla...</h2>
<h3>Please upload csv or txt file:</h3>
<form id="uploadForm" enctype="multipart/form-data" onsubmit="uploadFile(event)">
    <input type="file" name="file" id="fileInput" onchange="validateFileSelected()"/><br/><br/>
    <input type="submit" value="Submit" id="submitButton" disabled>
    <button type="button" onclick="clearFile()">Clear</button>
</form>
<div>
    <h3>or, please input smiles text: </h3>
    <input type="text" id="dataInput" placeholder="Enter data here">
    <button type="button" onclick="submitData()">Submit Data</button>
</div>
<div>
    <h2>Prediction Result</h2>
    <div id="resultContainer">
        <!-- Placeholder for displaying prediction result -->
    </div>
    <div id="errorContainer">
        <!-- Placeholder for displaying error message -->
    </div>
</div>

<button id="backToHome" onclick="redirectToHome()">Back to Home</button>

<script>
    function validateFileSelected() {
        var fileInput = document.getElementById('fileInput');
        var submitButton = document.getElementById('submitButton');

        // Check if a file is selected
        if (fileInput.files.length > 0) {
            submitButton.disabled = false; // Enable the submit button
        } else {
            submitButton.disabled = true; // Disable the submit button
        }
    }

    function clearFile() {
        var fileInput = document.getElementById('fileInput');
        fileInput.value = ''; // Clear the selected file
        validateFileSelected(); // Update the submit button state
    }

    function updateResultContainer(data) {
        var resultContainer = document.getElementById('resultContainer');
        var resultTextBox = document.getElementById('resultTextBox');

        if (!resultTextBox) {
            // If resultTextBox doesn't exist, create a new one
            resultTextBox = document.createElement('textarea');
            resultTextBox.id = 'resultTextBox';
            resultTextBox.rows = 5;
            resultTextBox.cols = 50;
            resultContainer.appendChild(resultTextBox);
        }

        if (data.code === 200) {
            // Show result in the text box
            // resultTextBox.innerHTML = JSON.stringify(data.result);
            resultTextBox.innerHTML = `Probability: ${JSON.stringify(data.result.probability)}\nSmiles: ${JSON.stringify(data.result.smiles)}\nTime: ${timestampToLocalTime(data.timestamp)}`;
        } else {
            // Show error message
            resultTextBox.innerHTML = `Error: ${data.message} (Error code: ${data.code})\nTime: ${timestampToLocalTime(data.timestamp)}`;
        }
    }

    function uploadFile(event) {
        event.preventDefault(); // Prevent the default form submission
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];

        // Check if a file is selected
        if (!file) {
            alert('Please select a file.');
            return;
        }

        // Check file extension
        var allowedExtensions = ['.csv', '.txt'];
        var fileExtension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
        if (!allowedExtensions.includes(fileExtension)) {
            alert('Only .csv or .txt files are allowed.');
            return;
        }

        // Check file size
        var maxSizeInBytes = 1024; // 1KB (in bytes)
        if (file.size > maxSizeInBytes) {
            alert('File size exceeds the maximum limit (1KB).');
            return;
        }

        var formData = new FormData();
        formData.append('file', file);

        // Replace the URL below with your backend endpoint for file upload
        var uploadURL = './request/upload';

        fetch(uploadURL, {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                updateResultContainer(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function redirectToHome() {
         // Replace with your home page URL
        window.location.href = "/";
    }
    function submitData() {
        var dataInput = document.getElementById('dataInput');
        var data = dataInput.value.trim();

        // Check if data is not empty
        if (!data) {
            alert('Please enter data.');
            return;
        }

        // Check data length
        var maxSizeInBytes = 1024; // 1KB (in bytes)
        if (new Blob([data]).size > maxSizeInBytes) {
            alert('Data size exceeds the maximum limit (1KB).');
            return;
        }

        // Replace the URL below with your backend endpoint for data submission
        var submitURL = './request/submit';

        // Use GET request to send data
        fetch(`${submitURL}?smiles=${encodeURIComponent(data)}`)
            .then(response => response.json())
            .then(data => {
                updateResultContainer(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function timestampToLocalTime(timestamp) {
        const dateObj = new Date(timestamp);
        const options = {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false, // Use 24-hour format
        };

        return dateObj.toLocaleString('zh-CN', options);
    }

    var submitButton = document.getElementById('submitButton');
    submitButton.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent the default form submission
        uploadFile(event);
    });
</script>
</body>
</html>
